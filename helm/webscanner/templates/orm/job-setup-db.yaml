apiVersion: batch/v1
kind: Job
metadata:
  creationTimestamp: null
  name: {{ .Values.orm.job.name }}
  namespace: {{ .Values.namespace }}
spec:
  template:
    metadata:
      creationTimestamp: null
    spec:
      serviceAccountName: job-watcher
      initContainers:
        - name: job-waiter
          image: bitnami/kubectl:latest
          command:
          - /bin/sh
          - -c
          - |
            until [ "$(kubectl get job {{ .Values.postgres.job.name }} -o jsonpath='{.status.conditions[?(@.type=="Complete")].status}')" == "True" ]; do
              echo "db needs to be setup"
              sleep 5
            done
            echo "Db is now set up!"
      containers:
      - image: job-web-scan-setup
        name: {{ .Values.orm.job.name }}
        env:
        - name: DATABASE_URL
          value: {{ .Values.orm.dbUrl }}
        resources: {}
      restartPolicy: Never
